{%- if section.settings.allow_transparent_header -%}
  <style>
    #shopify-section-{{ section.id }} {
        margin-block-start: calc(-1 * var(--header-height) * var(--section-is-first));
    }
      #shopify-section-{{ section.id }}>.section{
        padding-block-start: calc(1.1 * var(--header-height) * var(--section-is-first));
    }
  </style>
{%- endif -%}
{%- comment -%}
  ------------------------------------------------------------------------------------------------------------------------
  LIQUID
  ------------------------------------------------------------------------------------------------------------------------
{%- endcomment -%}
{% if section.settings.full_height %}
  {% capture class %}full_height{% endcapture %}
{% endif %}
<div
  {% render 'section-properties', class: class %}
  {% if section.settings.allow_transparent_header %}
    allow-transparent-header
  {% endif %}
>
  <div class="sm:container">
    <div class="customer-form">
      {%- if section.settings.image != blank -%}
        {{-
          section.settings.image
          | image_url: width: section.settings.image.width
          | image_tag:
            loading: 'lazy',
            sizes: '50vw',
            widths: '300,400,500,600,700,800,1000,1200,1400',
            class: 'customer-form__image rounded'
        -}}
      {%- endif -%}

      <div
        {% render 'surface',
          class: 'customer-form__box',
          background_gradient: section.settings.background_gradient_inner,
          background: section.settings.background_inner,
          text_color: section.settings.text_color,
          background_fallback: 'bg-secondary'
        %}
      >
        <account-login class="customer-form__box-inner text-center">
          <div id="login" class="v-stack gap-4">
            <h1 class="h2">
              {%- assign content = section.settings.heading -%}
              {%- render 'styled-text', content: content, gradient: section.settings.heading_gradient -%}
            </h1>
            {%- if section.settings.subheading != blank -%}
              <p class="bold">{{ section.settings.subheading | escape }}</p>
            {%- endif -%}

            <div class="v-stack gap-6">
              {%- for block in section.blocks -%}
                {%- case block.type -%}
                  {%- when '@app' -%}
                    {%- render block -%}

                  {%- when 'liquid' -%}
                    {%- if block.settings.liquid != blank -%}
                      <div {{ block.shopify_attributes }}>
                        {{- block.settings.liquid -}}
                      </div>
                    {%- endif -%}

                  {%- when 'fields' -%}
                    <div {{ block.shopify_attributes }}>
                      {%- form 'customer_login', class: 'form' -%}
                        <input
                          type="hidden"
                          name="checkout_url"
                          value="{{ block.settings.return_to | default: routes.account_url }}"
                        >
                        <!-- REDIRECT_TO_LIBRARY -->
                        <input type="hidden" name="return_to" val="">
                        <script>
                        let url = new URL(window.location);
                        let params = new URLSearchParams(url.search);
                        let redirect_url = params.get("redirect_uri");
                        if (redirect_url) {
                          if (redirect_url.indexOf('library') > 0) {
                            if (redirect_url.split('/').length === 4) {
                              redirect_url = `/apps/library/mvod/${redirect_url.split("/")[3]}/`;
                            }
                            let inputs = document.querySelectorAll('input[name="return_to"]');
                            inputs.forEach(input => {
                              input.value = redirect_url;
                            });
                          } else if (redirect_url.indexOf('/cart') > 0) {
                            // If redirect_uri contains /cart, redirect the user to the cart page
                            window.location.href = 'https://inviz.tv/cart';
                          }
                        }
                        </script>
                        <!-- REDIRECT_TO_LIBRARY -->
                        <div class="fieldset">
                          {%- if form.errors -%}
                            {%- render 'banner', status: 'error', content: form.errors.messages.form -%}
                          {%- endif -%}

                          {%- assign email_label = 'customer.login.email' | t -%}
                          {%- render 'input',
                            type: 'email',
                            name: 'customer[email]',
                            label: email_label,
                            autocomplete: 'email',
                            required: true
                          -%}

                          {%- assign password_label = 'customer.login.password' | t -%}
                          {%- render 'input',
                            type: 'password',
                            name: 'customer[password]',
                            label: password_label,
                            autocomplete: 'current-password',
                            required: true
                          -%}

                          <div class="fieldset-link justify-self-start">
                            <a href="#recover" class="link text-sm text-subdued">
                              {{- 'customer.login.forgot_password' | t -}}
                            </a>
                          </div>
                        </div>

                        {%- assign submit_label = 'customer.login.submit' | t -%}
                        {%- render 'button',
                          content: submit_label,
                          type: 'submit',
                          size: section.settings.button_size,
                          style: section.settings.button_style,
                          stretch: true,
                          secondary: true,
                          background: section.settings.button_background,
                          text_color: section.settings.button_text_color
                        -%}

                        <div>
                          {% assign redirect_uri_param = 'redirect_uri=/cart' %}
                          {% assign query_params = request.query_string | split: '&' %}
                          {% if query_params contains redirect_uri_param %}
                          {% else %}
                            <a href="{{ routes.account_register_url }}" class="link text-subdued">
                              {{- 'customer.login.sign_up' | t -}}
                            </a>
                          {% endif %}
                        </div>
                      {%- endform -%}
                    </div>
                {%- endcase -%}
              {%- endfor -%}
            </div>
          </div>

          <div id="recover" class="v-stack gap-12" hidden>
            <h1 class="h2">
              {%- assign content = 'customer.recover_password.title' | t -%}
              {%- render 'styled-text', content: content, gradient: section.settings.heading_gradient -%}
            </h1>

            {%- form 'recover_customer_password', class: 'form' -%}
              <div class="fieldset">
                {%- if form.errors -%}
                  {%- render 'banner', status: 'error', content: form.errors.messages.form -%}
                {%- endif -%}

                {%- if form.posted_successfully? -%}
                  {%- assign success_message = 'customer.recover_password.success_message' | t -%}
                  {%- render 'banner', status: 'success', content: success_message -%}
                {%- else -%}
                  {%- assign email_label = 'customer.recover_password.email' | t -%}
                  {%- render 'input',
                    type: 'email',
                    name: 'email',
                    label: email_label,
                    autocomplete: 'email',
                    required: true
                  -%}
                {%- endif -%}
              </div>

              {%- unless form.posted_successfully? -%}
                {%- assign submit_label = 'customer.recover_password.submit' | t -%}
                {%- render 'button',
                  content: submit_label,
                  type: 'submit',
                  size: section.settings.button_size,
                  style: section.settings.button_style,
                  stretch: true,
                  secondary: true,
                  background: section.settings.button_background,
                  text_color: section.settings.button_text_color
                -%}
              {%- endunless -%}

              <div>
                <a href="#login" class="link text-subdued">{{ 'customer.recover_password.back_to_login' | t }}</a>
              </div>
            {%- endform -%}
          </div>
        </account-login>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var queryString = window.location.search;
    var urlParams = new URLSearchParams(queryString);
    var redirectUri = urlParams.get('redirect_uri');

    if (redirectUri && redirectUri === "/cart") {
      // Modify the href attribute of the <a> element
      var signUpLink = document.querySelector('a[href="/account/register"]');
      if (signUpLink) {
        signUpLink.setAttribute("href", "/account/register?redirect_uri=/checkout");
      }
    }
  });
</script>
{% schema %}
{
  "name": "Customer login",
  "class": "shopify-section--main-customers-login",
  "tag": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "full_height",
      "label": "Full Height",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "allow_transparent_header",
      "label": "Allow transparent header",
      "info": "This setting only applies when this section is the first one.",
      "default": false
    },
    {
      "type": "header",
      "content": "Section colors",
      "info": "Background Image replaces Gradient replaces solid colors when set."
    },
    {
      "type": "image_picker",
      "id": "background_img",
      "label": "Section Background Image"
    },
    {
      "type": "image_picker",
      "id": "mob_background_img",
      "label": "Mobile Section Background Image"
    },
    {
      "type": "color",
      "id": "background",
      "label": "Background"
    },
    {
      "type": "color_background",
      "id": "background_gradient",
      "label": "Background gradient"
    },
    {
      "type": "header",
      "content": "Login Form",
      "info": "Login Form Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Login"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Image",
      "info": "1400 x 1400px .jpg recommended. Does not show on mobile."
    },
    {
      "type": "header",
      "content": "Colors",
      "info": "Gradient replaces solid colors when set."
    },
    {
      "type": "color",
      "id": "background_inner",
      "label": "Background"
    },
    {
      "type": "color_background",
      "id": "background_gradient_inner",
      "label": "Background gradient"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text"
    },
    {
      "type": "color_background",
      "id": "heading_gradient",
      "label": "Heading gradient"
    },
    {
      "type": "color",
      "id": "button_background",
      "label": "Button background"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text"
    },
    {
       "type": "select",
       "id": "button_style",
       "label": "Style",
       "options": [
         {
          "value": "outline",
          "label": "Outline"
         },
         {
           "value": "fill",
           "label": "Fill"
         }
       ],
      "default": "fill"
    },
    {
    "type": "select",
    "id": "button_size",
     "label": "Size",
     "options": [
        {
         "value": "sm",
         "label": "Small"
        },
        {
        "value": "base",
        "label": "Medium"
        },
        {
        "value": "lg",
        "label": "Large"
        },
        {
          "value": "xl",
          "label": "X-Large"
        }
       ],
      "default": "lg"
    }
  ],
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "fields",
      "name": "Fields",
      "limit": 1,
      "settings": [
        {
          "type": "url",
          "id": "return_to",
          "label": "Redirect upon login",
          "info": "Default to customer account page."
        }
      ]
    },
    {
      "type": "liquid",
      "name": "Liquid",
      "settings": [
        {
          "type": "liquid",
          "id": "liquid",
          "label": "Liquid"
        }
      ]
    }
  ]
}
{% endschema %}
